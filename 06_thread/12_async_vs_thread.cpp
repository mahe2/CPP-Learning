/*
 * async å’Œ thread + join çš„åŒºåˆ«è¯¦è§£
 * æ ¸å¿ƒï¼šç†è§£ä¸¤è€…çš„è®¾è®¡ç›®æ ‡ã€ä½¿ç”¨æ–¹å¼å’Œé€‚ç”¨åœºæ™¯
 */

#include <iostream>
#include <thread>
#include <future>
#include <chrono>
#include <vector>
using namespace std;

// ============================================================================
// ä¸€ã€æ ¸å¿ƒåŒºåˆ«æ¦‚è§ˆ
// ============================================================================

void explain_core_differences() {
    cout << "\n=== 1. async vs thread + join æ ¸å¿ƒåŒºåˆ« ===" << endl;
    
    cout << "\nè®¾è®¡ç›®æ ‡ï¼š" << endl;
    cout << "  thread + join:" << endl;
    cout << "    âœ… åº•å±‚ APIï¼Œç²¾ç¡®æ§åˆ¶çº¿ç¨‹" << endl;
    cout << "    âœ… æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ" << endl;
    cout << "    âœ… çµæ´»ä½†å¤æ‚" << endl;
    
    cout << "\n  async:" << endl;
    cout << "    âœ… é«˜å±‚ APIï¼Œå…³æ³¨ä»»åŠ¡è€Œéçº¿ç¨‹" << endl;
    cout << "    âœ… è‡ªåŠ¨ç®¡ç†çº¿ç¨‹" << endl;
    cout << "    âœ… ç®€å•ä½†é™åˆ¶å¤š" << endl;
    
    cout << "\nå…³é”®åŒºåˆ«ï¼š" << endl;
    cout << "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" << endl;
    cout << "  â”‚ ç‰¹æ€§             â”‚ thread + join      â”‚ async            â”‚" << endl;
    cout << "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" << endl;
    cout << "  â”‚ è¿”å›å€¼           â”‚ âŒ ä¸æ”¯æŒï¼ˆé—´æ¥ï¼‰  â”‚ âœ… ç›´æ¥æ”¯æŒ      â”‚" << endl;
    cout << "  â”‚ å¼‚å¸¸å¤„ç†         â”‚ âš ï¸ éœ€æ‰‹åŠ¨å¤„ç†      â”‚ âœ… è‡ªåŠ¨ä¼ é€’      â”‚" << endl;
    cout << "  â”‚ èµ„æºç®¡ç†         â”‚ âš ï¸ æ‰‹åŠ¨ join/detachâ”‚ âœ… RAII è‡ªåŠ¨ç®¡ç† â”‚" << endl;
    cout << "  â”‚ æ‰§è¡Œç­–ç•¥         â”‚ âŒ æ€»æ˜¯åˆ›å»ºçº¿ç¨‹    â”‚ âœ… å¯é€‰ç­–ç•¥      â”‚" << endl;
    cout << "  â”‚ é˜»å¡æ—¶æœº         â”‚ join() æ—¶é˜»å¡      â”‚ get() æ—¶é˜»å¡     â”‚" << endl;
    cout << "  â”‚ æ§åˆ¶ç²’åº¦         â”‚ âœ… ç²¾ç»†æ§åˆ¶        â”‚ âš ï¸ ç²—ç²’åº¦        â”‚" << endl;
    cout << "  â”‚ æ˜“ç”¨æ€§           â”‚ â­â­              â”‚ â­â­â­â­â­      â”‚" << endl;
    cout << "  â”‚ çµæ´»æ€§           â”‚ â­â­â­â­â­        â”‚ â­â­â­          â”‚" << endl;
    cout << "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" << endl;
}

// ============================================================================
// äºŒã€åŒºåˆ«1ï¼šè¿”å›å€¼å¤„ç†
// ============================================================================

int compute_sum(int n) {
    int sum = 0;
    for (int i = 1; i <= n; i++) {
        sum += i;
    }
    return sum;
}

void demonstrate_return_value() {
    cout << "\n=== 2. åŒºåˆ«1ï¼šè¿”å›å€¼å¤„ç† ===" << endl;
    
    cout << "\næ–¹å¼1ï¼šthread + joinï¼ˆéœ€è¦é—´æ¥è·å–ï¼‰" << endl;
    {
        int result = 0;  // âš ï¸ éœ€è¦æå‰å‡†å¤‡å­˜å‚¨å˜é‡
        
        thread t([&result]() {
            result = compute_sum(100);  // âš ï¸ æ‰‹åŠ¨èµ‹å€¼
        });
        
        t.join();  // âš ï¸ å¿…é¡»æ‰‹åŠ¨ join
        
        cout << "  ç»“æœ: " << result << endl;
        cout << "  ä»£ç è¡Œæ•°: 4 è¡Œ" << endl;
    }
    
    cout << "\næ–¹å¼2ï¼šasyncï¼ˆç›´æ¥è¿”å›ï¼‰" << endl;
    {
        auto fut = async(launch::async, compute_sum, 100);  // âœ… ç›´æ¥è¿”å› future
        
        int result = fut.get();  // âœ… ç›´æ¥è·å–ç»“æœ
        
        cout << "  ç»“æœ: " << result << endl;
        cout << "  ä»£ç è¡Œæ•°: 2 è¡Œ" << endl;
    }
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: å‡½æ•°è¿”å›å€¼è¢«ä¸¢å¼ƒï¼Œéœ€è¦é€šè¿‡å¼•ç”¨/æŒ‡é’ˆä¼ é€’ç»“æœ" << endl;
    cout << "  async:  å‡½æ•°è¿”å›å€¼å­˜å‚¨åœ¨ future ä¸­ï¼Œç›´æ¥ get() è·å–" << endl;
}

// ============================================================================
// ä¸‰ã€åŒºåˆ«2ï¼šå¼‚å¸¸å¤„ç†
// ============================================================================

int risky_compute(int n) {
    if (n < 0) {
        throw runtime_error("è´Ÿæ•°ä¸æ”¯æŒï¼");
    }
    return n * n;
}

void demonstrate_exception_handling() {
    cout << "\n=== 3. åŒºåˆ«2ï¼šå¼‚å¸¸å¤„ç† ===" << endl;
    
    cout << "\næ–¹å¼1ï¼šthread + joinï¼ˆå¼‚å¸¸ä¸¢å¤±ï¼ï¼‰" << endl;
    {
        int result = 0;
        
        thread t([&result]() {
            try {
                result = risky_compute(-5);  // âŒ å¼‚å¸¸åœ¨çº¿ç¨‹å†…éƒ¨
            } catch (const exception& e) {
                cout << "  [çº¿ç¨‹å†…æ•è·] " << e.what() << endl;
                // âŒ æ— æ³•ä¼ é€’åˆ°ä¸»çº¿ç¨‹ï¼
            }
        });
        
        t.join();
        
        cout << "  ä¸»çº¿ç¨‹æ— æ³•çŸ¥é“çº¿ç¨‹å†…éƒ¨å‘ç”Ÿäº†å¼‚å¸¸ï¼" << endl;
    }
    
    cout << "\næ–¹å¼2ï¼šasyncï¼ˆå¼‚å¸¸è‡ªåŠ¨ä¼ é€’ï¼‰" << endl;
    {
        auto fut = async(launch::async, risky_compute, -5);
        
        try {
            int result = fut.get();  // âœ… get() æ—¶å¼‚å¸¸ä¼šè¢«é‡æ–°æŠ›å‡º
            cout << "  ç»“æœ: " << result << endl;
        } catch (const exception& e) {
            cout << "  [ä¸»çº¿ç¨‹æ•è·] " << e.what() << " âœ… å¼‚å¸¸æˆåŠŸä¼ é€’ï¼" << endl;
        }
    }
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: çº¿ç¨‹å†…å¼‚å¸¸æ— æ³•ä¼ é€’åˆ°ä¸»çº¿ç¨‹ï¼Œåªèƒ½åœ¨çº¿ç¨‹å†…å¤„ç†" << endl;
    cout << "  async:  å¼‚å¸¸å­˜å‚¨åœ¨ future ä¸­ï¼Œget() æ—¶é‡æ–°æŠ›å‡º" << endl;
}

// ============================================================================
// å››ã€åŒºåˆ«3ï¼šèµ„æºç®¡ç†ï¼ˆRAIIï¼‰
// ============================================================================

void demonstrate_resource_management() {
    cout << "\n=== 4. åŒºåˆ«3ï¼šèµ„æºç®¡ç† ===" << endl;
    
    cout << "\næ–¹å¼1ï¼šthreadï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼Œå®¹æ˜“å¿˜è®°ï¼‰" << endl;
    cout << "  thread t(task);" << endl;
    cout << "  // ... ä»£ç  ..." << endl;
    cout << "  t.join();  // âš ï¸ å¿…é¡»æ‰‹åŠ¨ join æˆ– detach" << endl;
    cout << "  // å¿˜è®° join â†’ ç¨‹åºå´©æºƒï¼" << endl;
    
    cout << "\n  // âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå´©æºƒï¼‰" << endl;
    cout << "  {" << endl;
    cout << "      thread t(task);" << endl;
    cout << "      // å¿˜è®° join" << endl;
    cout << "  }  // â† ææ„æ—¶å´©æºƒï¼šstd::terminate()" << endl;
    
    cout << "\næ–¹å¼2ï¼šasyncï¼ˆRAII è‡ªåŠ¨ç®¡ç†ï¼‰" << endl;
    {
        auto start = chrono::high_resolution_clock::now();
        
        {
            auto fut = async(launch::async, []() {
                this_thread::sleep_for(chrono::milliseconds(100));
                cout << "  [ä»»åŠ¡] æ‰§è¡Œä¸­..." << endl;
            });
            
            cout << "  [ä¸»çº¿ç¨‹] future å¯¹è±¡å³å°†ææ„..." << endl;
            // âœ… future ææ„æ—¶è‡ªåŠ¨ç­‰å¾…ä»»åŠ¡å®Œæˆï¼
        }  // â† future ææ„ï¼Œè‡ªåŠ¨ wait
        
        auto duration = chrono::duration_cast<chrono::milliseconds>(
            chrono::high_resolution_clock::now() - start
        );
        
        cout << "  [ä¸»çº¿ç¨‹] è€—æ—¶: " << duration.count() << " ms" << endl;
        cout << "  âœ… ä»»åŠ¡å·²è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€æ‰‹åŠ¨ join" << endl;
    }
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: ææ„å‰å¿…é¡» join æˆ– detachï¼Œå¦åˆ™ std::terminate()" << endl;
    cout << "  async:  future ææ„æ—¶è‡ªåŠ¨ç­‰å¾…ï¼Œç¬¦åˆ RAII åŸåˆ™" << endl;
}

// ============================================================================
// äº”ã€åŒºåˆ«4ï¼šæ‰§è¡Œç­–ç•¥
// ============================================================================

void demonstrate_launch_policy() {
    cout << "\n=== 5. åŒºåˆ«4ï¼šæ‰§è¡Œç­–ç•¥ ===" << endl;
    
    cout << "\nthreadï¼šæ€»æ˜¯åˆ›å»ºæ–°çº¿ç¨‹" << endl;
    {
        thread t([]() {
            cout << "  [thread] åœ¨æ–°çº¿ç¨‹æ‰§è¡Œï¼ŒID: " 
                 << this_thread::get_id() << endl;
        });
        t.join();
        cout << "  ä¸»çº¿ç¨‹ ID: " << this_thread::get_id() << endl;
    }
    
    cout << "\nasyncï¼šå¯ä»¥é€‰æ‹©æ‰§è¡Œç­–ç•¥" << endl;
    
    cout << "\nç­–ç•¥1ï¼šlaunch::asyncï¼ˆå¼ºåˆ¶å¼‚æ­¥ï¼‰" << endl;
    {
        auto fut = async(launch::async, []() {
            cout << "  [async] åœ¨æ–°çº¿ç¨‹æ‰§è¡Œï¼ŒID: " 
                 << this_thread::get_id() << endl;
            return 42;
        });
        cout << "  ä¸»çº¿ç¨‹ ID: " << this_thread::get_id() << endl;
        fut.get();
    }
    
    cout << "\nç­–ç•¥2ï¼šlaunch::deferredï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼‰" << endl;
    {
        cout << "  [ä¸»çº¿ç¨‹] åˆ›å»º async..." << endl;
        
        auto fut = async(launch::deferred, []() {
            cout << "  [deferred] åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼ŒID: " 
                 << this_thread::get_id() << endl;
            return 42;
        });
        
        cout << "  [ä¸»çº¿ç¨‹] ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œ..." << endl;
        cout << "  [ä¸»çº¿ç¨‹] è°ƒç”¨ get()..." << endl;
        
        fut.get();  // âœ… åœ¨è°ƒç”¨ get() æ—¶æ‰åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
        
        cout << "  ä¸»çº¿ç¨‹ ID: " << this_thread::get_id() << endl;
    }
    
    cout << "\nç­–ç•¥3ï¼šlaunch::async | launch::deferredï¼ˆé»˜è®¤ï¼Œè‡ªåŠ¨é€‰æ‹©ï¼‰" << endl;
    cout << "  ç³»ç»Ÿæ ¹æ®è´Ÿè½½è‡ªåŠ¨å†³å®šå¼‚æ­¥è¿˜æ˜¯å»¶è¿Ÿ" << endl;
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: æ€»æ˜¯åˆ›å»ºçº¿ç¨‹ï¼Œæ— æ³•é€‰æ‹©" << endl;
    cout << "  async:  å¯ä»¥é€‰æ‹©ç­–ç•¥ï¼Œæ›´çµæ´»" << endl;
}

// ============================================================================
// å…­ã€åŒºåˆ«5ï¼šé˜»å¡æ—¶æœº
// ============================================================================

void demonstrate_blocking_timing() {
    cout << "\n=== 6. åŒºåˆ«5ï¼šé˜»å¡æ—¶æœº ===" << endl;
    
    cout << "\nthread + joinï¼šjoin() æ—¶é˜»å¡" << endl;
    {
        auto start = chrono::high_resolution_clock::now();
        
        thread t([]() {
            this_thread::sleep_for(chrono::milliseconds(200));
        });
        
        cout << "  [ä¸»çº¿ç¨‹] çº¿ç¨‹å·²åˆ›å»ºï¼Œç»§ç»­å·¥ä½œ..." << endl;
        this_thread::sleep_for(chrono::milliseconds(100));
        
        cout << "  [ä¸»çº¿ç¨‹] è°ƒç”¨ join()ï¼Œå¼€å§‹é˜»å¡..." << endl;
        t.join();  // â† è¿™é‡Œé˜»å¡
        
        auto duration = chrono::duration_cast<chrono::milliseconds>(
            chrono::high_resolution_clock::now() - start
        );
        cout << "  [ä¸»çº¿ç¨‹] join è¿”å›ï¼Œæ€»è€—æ—¶: " << duration.count() << " ms" << endl;
    }
    
    cout << "\nasyncï¼šget() æ—¶é˜»å¡" << endl;
    {
        auto start = chrono::high_resolution_clock::now();
        
        auto fut = async(launch::async, []() {
            this_thread::sleep_for(chrono::milliseconds(200));
            return 42;
        });
        
        cout << "  [ä¸»çº¿ç¨‹] future å·²åˆ›å»ºï¼Œç»§ç»­å·¥ä½œ..." << endl;
        this_thread::sleep_for(chrono::milliseconds(100));
        
        cout << "  [ä¸»çº¿ç¨‹] è°ƒç”¨ get()ï¼Œå¼€å§‹é˜»å¡..." << endl;
        int result = fut.get();  // â† è¿™é‡Œé˜»å¡
        
        auto duration = chrono::duration_cast<chrono::milliseconds>(
            chrono::high_resolution_clock::now() - start
        );
        cout << "  [ä¸»çº¿ç¨‹] get è¿”å›ï¼Œç»“æœ: " << result 
             << "ï¼Œæ€»è€—æ—¶: " << duration.count() << " ms" << endl;
    }
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: join() é˜»å¡ï¼Œåªèƒ½ç­‰å¾…ï¼Œæ— æ³•è·å–è¿”å›å€¼" << endl;
    cout << "  async:  get() é˜»å¡ï¼Œç­‰å¾… + è·å–è¿”å›å€¼ä¸€æ­¥å®Œæˆ" << endl;
}

// ============================================================================
// ä¸ƒã€åŒºåˆ«6ï¼šæ§åˆ¶ç²’åº¦
// ============================================================================

void demonstrate_control_granularity() {
    cout << "\n=== 7. åŒºåˆ«6ï¼šæ§åˆ¶ç²’åº¦ ===" << endl;
    
    cout << "\nthreadï¼šç²¾ç»†æ§åˆ¶" << endl;
    cout << "  å¯ä»¥æ§åˆ¶çš„å†…å®¹ï¼š" << endl;
    cout << "    âœ… çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆå¹³å°ç›¸å…³ï¼‰" << endl;
    cout << "    âœ… CPU äº²å’Œæ€§ï¼ˆç»‘å®šåˆ°ç‰¹å®šæ ¸å¿ƒï¼‰" << endl;
    cout << "    âœ… æ ˆå¤§å°ï¼ˆå¹³å°ç›¸å…³ï¼‰" << endl;
    cout << "    âœ… è°ƒåº¦ç­–ç•¥" << endl;
    cout << "    âœ… joinable çŠ¶æ€æ£€æŸ¥" << endl;
    cout << "    âœ… å¯ä»¥ detach" << endl;
    
    cout << "\n  ç¤ºä¾‹ï¼šè·å–çº¿ç¨‹ ID" << endl;
    {
        thread t([]() {
            cout << "    çº¿ç¨‹ ID: " << this_thread::get_id() << endl;
        });
        
        cout << "    ä¸»çº¿ç¨‹å¯ä»¥è®¿é—®çº¿ç¨‹å¯¹è±¡" << endl;
        cout << "    çº¿ç¨‹ ID: " << t.get_id() << endl;
        cout << "    joinable: " << (t.joinable() ? "æ˜¯" : "å¦") << endl;
        
        t.join();
    }
    
    cout << "\nasyncï¼šç²—ç²’åº¦æ§åˆ¶" << endl;
    cout << "  åªèƒ½æ§åˆ¶ï¼š" << endl;
    cout << "    âš ï¸ æ‰§è¡Œç­–ç•¥ï¼ˆasync/deferredï¼‰" << endl;
    cout << "    âŒ æ— æ³•è®¿é—®åº•å±‚çº¿ç¨‹å¯¹è±¡" << endl;
    cout << "    âŒ æ— æ³•è®¾ç½®ä¼˜å…ˆçº§" << endl;
    cout << "    âŒ æ— æ³•è®¾ç½® CPU äº²å’Œæ€§" << endl;
    cout << "    âŒ æ— æ³• detach" << endl;
    
    cout << "\nå…³é”®ç‚¹ï¼š" << endl;
    cout << "  thread: åº•å±‚ APIï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶çº¿ç¨‹" << endl;
    cout << "  async:  é«˜å±‚ APIï¼Œå…³æ³¨ä»»åŠ¡è€Œéçº¿ç¨‹" << endl;
}

// ============================================================================
// å…«ã€å®é™…åœºæ™¯å¯¹æ¯”
// ============================================================================

void demonstrate_practical_scenarios() {
    cout << "\n=== 8. å®é™…åœºæ™¯å¯¹æ¯” ===" << endl;
    
    cout << "\nåœºæ™¯1ï¼šç®€å•çš„å¼‚æ­¥è®¡ç®—" << endl;
    cout << "  æ¨èï¼šasyncï¼ˆä»£ç ç®€æ´ï¼‰" << endl;
    {
        // âœ… async æ–¹å¼ï¼ˆ2 è¡Œï¼‰
        auto fut = async(launch::async, compute_sum, 1000);
        cout << "    ç»“æœ: " << fut.get() << endl;
        
        // âš ï¸ thread æ–¹å¼ï¼ˆ4 è¡Œï¼‰
        // int result = 0;
        // thread t([&result]() { result = compute_sum(1000); });
        // t.join();
        // cout << result;
    }
    
    cout << "\nåœºæ™¯2ï¼šå¤šä¸ªå¼‚æ­¥ä»»åŠ¡" << endl;
    cout << "  æ¨èï¼šasyncï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰" << endl;
    {
        vector<future<int>> futures;
        
        // å¯åŠ¨å¤šä¸ªä»»åŠ¡
        for (int i = 1; i <= 3; i++) {
            futures.push_back(async(launch::async, compute_sum, i * 100));
        }
        
        // è·å–æ‰€æœ‰ç»“æœ
        for (int i = 0; i < 3; i++) {
            cout << "    ä»»åŠ¡ " << i + 1 << " ç»“æœ: " << futures[i].get() << endl;
        }
    }
    
    cout << "\nåœºæ™¯3ï¼šéœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹" << endl;
    cout << "  æ¨èï¼šthreadï¼ˆæ›´çµæ´»ï¼‰" << endl;
    cout << "    ä¾‹å¦‚ï¼š" << endl;
    cout << "      - è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§" << endl;
    cout << "      - ç»‘å®šåˆ°ç‰¹å®š CPU æ ¸å¿ƒ" << endl;
    cout << "      - å®ç°è‡ªå®šä¹‰çº¿ç¨‹æ± " << endl;
    cout << "      - é•¿æœŸè¿è¡Œçš„åå°çº¿ç¨‹" << endl;
    
    cout << "\nåœºæ™¯4ï¼šå¯èƒ½éœ€è¦å–æ¶ˆçš„ä»»åŠ¡" << endl;
    cout << "  æ¨èï¼šasyncï¼ˆfuture æ”¯æŒ wait_forï¼‰" << endl;
    {
        auto fut = async(launch::async, []() {
            this_thread::sleep_for(chrono::milliseconds(100));
            return 42;
        });
        
        // ç­‰å¾…æœ€å¤š 50ms
        auto status = fut.wait_for(chrono::milliseconds(50));
        
        if (status == future_status::ready) {
            cout << "    ä»»åŠ¡å·²å®Œæˆ: " << fut.get() << endl;
        } else {
            cout << "    ä»»åŠ¡è¿˜åœ¨è¿è¡Œ..." << endl;
            fut.wait();  // ç»§ç»­ç­‰å¾…
            cout << "    ä»»åŠ¡å®Œæˆ: " << fut.get() << endl;
        }
    }
}

// ============================================================================
// ä¹ã€æ€§èƒ½å¯¹æ¯”
// ============================================================================

void demonstrate_performance() {
    cout << "\n=== 9. æ€§èƒ½å¯¹æ¯” ===" << endl;
    
    const int NUM_TASKS = 100;
    
    cout << "\næµ‹è¯•ï¼šåˆ›å»º " << NUM_TASKS << " ä¸ªä»»åŠ¡" << endl;
    
    cout << "\næ–¹å¼1ï¼šthread + join" << endl;
    {
        auto start = chrono::high_resolution_clock::now();
        
        for (int i = 0; i < NUM_TASKS; i++) {
            thread t([]() {
                // å¿«é€Ÿä»»åŠ¡
                volatile int sum = 0;
                for (int j = 0; j < 1000; j++) sum += j;
            });
            t.join();
        }
        
        auto duration = chrono::duration_cast<chrono::milliseconds>(
            chrono::high_resolution_clock::now() - start
        );
        cout << "  è€—æ—¶: " << duration.count() << " ms" << endl;
    }
    
    cout << "\næ–¹å¼2ï¼šasyncï¼ˆé»˜è®¤ç­–ç•¥ï¼‰" << endl;
    {
        auto start = chrono::high_resolution_clock::now();
        
        for (int i = 0; i < NUM_TASKS; i++) {
            auto fut = async([]() {
                volatile int sum = 0;
                for (int j = 0; j < 1000; j++) sum += j;
                return sum;
            });
            fut.get();
        }
        
        auto duration = chrono::duration_cast<chrono::milliseconds>(
            chrono::high_resolution_clock::now() - start
        );
        cout << "  è€—æ—¶: " << duration.count() << " ms" << endl;
    }
    
    cout << "\nè§‚å¯Ÿï¼š" << endl;
    cout << "  async å¯èƒ½æ›´å¿«ï¼ˆå› ä¸ºå¯èƒ½ä½¿ç”¨ deferred ç­–ç•¥ï¼Œé¿å…çº¿ç¨‹åˆ›å»ºå¼€é”€ï¼‰" << endl;
    cout << "  ä½†å…·ä½“æ€§èƒ½å–å†³äºä»»åŠ¡ç‰¹æ€§å’Œç³»ç»Ÿå®ç°" << endl;
}

// ============================================================================
// åã€ä½•æ—¶ç”¨ threadï¼Œä½•æ—¶ç”¨ async
// ============================================================================

void when_to_use_what() {
    cout << "\n=== 10. ä½•æ—¶ç”¨ threadï¼Œä½•æ—¶ç”¨ async ===" << endl;
    
    cout << "\nâœ… ä½¿ç”¨ async çš„åœºæ™¯ï¼ˆæ¨èï¼Œ99% çš„æƒ…å†µï¼‰ï¼š" << endl;
    cout << "  1. éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥è®¡ç®—" << endl;
    cout << "  2. éœ€è¦ä¼ é€’å¼‚å¸¸" << endl;
    cout << "  3. ä¸å…³å¿ƒçº¿ç¨‹ç»†èŠ‚ï¼Œåªå…³å¿ƒç»“æœ" << endl;
    cout << "  4. æƒ³è¦ç®€æ´çš„ä»£ç " << endl;
    cout << "  5. éœ€è¦è¶…æ—¶ç­‰å¾…ï¼ˆwait_forï¼‰" << endl;
    cout << "  6. ä»»åŠ¡æ•°é‡ä¸å¤šï¼ˆå‡ åä¸ªï¼‰" << endl;
    cout << "  7. çŸ­æœŸä»»åŠ¡" << endl;
    
    cout << "\nâœ… ä½¿ç”¨ thread çš„åœºæ™¯ï¼š" << endl;
    cout << "  1. éœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹ï¼ˆä¼˜å…ˆçº§ã€äº²å’Œæ€§ç­‰ï¼‰" << endl;
    cout << "  2. é•¿æœŸè¿è¡Œçš„åå°çº¿ç¨‹" << endl;
    cout << "  3. å®ç°è‡ªå®šä¹‰çº¿ç¨‹æ± " << endl;
    cout << "  4. éœ€è¦ detach çš„åœºæ™¯" << endl;
    cout << "  5. ä¸æ—§ä»£ç å…¼å®¹" << endl;
    cout << "  6. éœ€è¦è®¿é—®åº•å±‚çº¿ç¨‹å¯¹è±¡" << endl;
    cout << "  7. å¤§é‡å¹¶å‘ä»»åŠ¡ï¼ˆé…åˆçº¿ç¨‹æ± ï¼‰" << endl;
    
    cout << "\nâš ï¸ ä¸ç¡®å®šç”¨å“ªä¸ªï¼Ÿâ†’ ç”¨ asyncï¼" << endl;
}

// ============================================================================
// åä¸€ã€æ ¸å¿ƒæ€»ç»“
// ============================================================================

void summary() {
    cout << "\n========================================" << endl;
    cout << "           æ ¸å¿ƒæ€»ç»“" << endl;
    cout << "========================================" << endl;
    
    cout << "\nasync vs thread + join å¯¹æ¯”ï¼š" << endl;
    
    cout << "\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" << endl;
    cout << "â”‚                    thread + join                            â”‚" << endl;
    cout << "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" << endl;
    cout << "â”‚ ä¼˜ç‚¹ï¼š                                                      â”‚" << endl;
    cout << "â”‚  âœ… ç²¾ç¡®æ§åˆ¶çº¿ç¨‹ï¼ˆä¼˜å…ˆçº§ã€äº²å’Œæ€§ã€æ ˆå¤§å°ç­‰ï¼‰                â”‚" << endl;
    cout << "â”‚  âœ… å¯ä»¥ detach                                             â”‚" << endl;
    cout << "â”‚  âœ… å¯ä»¥è®¿é—®çº¿ç¨‹å¯¹è±¡ï¼ˆget_id, joinable ç­‰ï¼‰                 â”‚" << endl;
    cout << "â”‚  âœ… é€‚åˆé•¿æœŸè¿è¡Œçš„åå°çº¿ç¨‹                                  â”‚" << endl;
    cout << "â”‚                                                             â”‚" << endl;
    cout << "â”‚ ç¼ºç‚¹ï¼š                                                      â”‚" << endl;
    cout << "â”‚  âŒ ä¸ç›´æ¥æ”¯æŒè¿”å›å€¼ï¼ˆéœ€è¦é—´æ¥ä¼ é€’ï¼‰                        â”‚" << endl;
    cout << "â”‚  âŒ å¼‚å¸¸æ— æ³•ä¼ é€’åˆ°ä¸»çº¿ç¨‹                                    â”‚" << endl;
    cout << "â”‚  âŒ å¿…é¡»æ‰‹åŠ¨ join æˆ– detachï¼Œå¦åˆ™å´©æºƒ                       â”‚" << endl;
    cout << "â”‚  âŒ ä»£ç ç›¸å¯¹å¤æ‚                                            â”‚" << endl;
    cout << "â”‚  âŒ æ€»æ˜¯åˆ›å»ºçº¿ç¨‹ï¼ˆå¼€é”€å¤§ï¼‰                                  â”‚" << endl;
    cout << "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" << endl;
    
    cout << "\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" << endl;
    cout << "â”‚                         async                               â”‚" << endl;
    cout << "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" << endl;
    cout << "â”‚ ä¼˜ç‚¹ï¼š                                                      â”‚" << endl;
    cout << "â”‚  âœ… ç›´æ¥æ”¯æŒè¿”å›å€¼ï¼ˆfuture.get()ï¼‰                          â”‚" << endl;
    cout << "â”‚  âœ… å¼‚å¸¸è‡ªåŠ¨ä¼ é€’                                            â”‚" << endl;
    cout << "â”‚  âœ… RAII è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨ join                            â”‚" << endl;
    cout << "â”‚  âœ… ä»£ç ç®€æ´ï¼ˆ2 è¡Œæå®šï¼‰                                    â”‚" << endl;
    cout << "â”‚  âœ… æ”¯æŒæ‰§è¡Œç­–ç•¥ï¼ˆasync/deferredï¼‰                          â”‚" << endl;
    cout << "â”‚  âœ… æ”¯æŒè¶…æ—¶ç­‰å¾…ï¼ˆwait_forï¼‰                                â”‚" << endl;
    cout << "â”‚  âœ… ç³»ç»Ÿå¯èƒ½ä¼˜åŒ–ï¼ˆå»¶è¿Ÿæ‰§è¡Œã€çº¿ç¨‹å¤ç”¨ï¼‰                      â”‚" << endl;
    cout << "â”‚                                                             â”‚" << endl;
    cout << "â”‚ ç¼ºç‚¹ï¼š                                                      â”‚" << endl;
    cout << "â”‚  âŒ æ— æ³•ç²¾ç¡®æ§åˆ¶çº¿ç¨‹                                        â”‚" << endl;
    cout << "â”‚  âŒ æ— æ³• detach                                             â”‚" << endl;
    cout << "â”‚  âŒ æ— æ³•è®¿é—®åº•å±‚çº¿ç¨‹å¯¹è±¡                                    â”‚" << endl;
    cout << "â”‚  âŒ ä¸é€‚åˆé•¿æœŸåå°ä»»åŠ¡                                      â”‚" << endl;
    cout << "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" << endl;
    
    cout << "\nä½¿ç”¨å»ºè®®ï¼š" << endl;
    cout << "  ğŸ¥‡ é»˜è®¤é€‰æ‹©ï¼šasyncï¼ˆç®€å•ã€å®‰å…¨ã€é«˜æ•ˆï¼‰" << endl;
    cout << "  ğŸ¥ˆ ç‰¹æ®Šéœ€æ±‚ï¼šthreadï¼ˆéœ€è¦ç²¾ç¡®æ§åˆ¶æ—¶ï¼‰" << endl;
    cout << "  ğŸ¥‰ å¤§é‡å¹¶å‘ï¼šçº¿ç¨‹æ± ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯ï¼‰" << endl;
    
    cout << "\nå†³ç­–æ ‘ï¼š" << endl;
    cout << "  éœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹ï¼Ÿ" << endl;
    cout << "    â””â”€ æ˜¯ â†’ thread" << endl;
    cout << "    â””â”€ å¦ â†’ ç»§ç»­" << endl;
    cout << "  " << endl;
    cout << "  éœ€è¦é•¿æœŸåå°çº¿ç¨‹ï¼Ÿ" << endl;
    cout << "    â””â”€ æ˜¯ â†’ thread" << endl;
    cout << "    â””â”€ å¦ â†’ ç»§ç»­" << endl;
    cout << "  " << endl;
    cout << "  éœ€è¦è¿”å›å€¼ï¼Ÿ" << endl;
    cout << "    â””â”€ æ˜¯ â†’ async âœ…" << endl;
    cout << "    â””â”€ å¦ â†’ async âœ…ï¼ˆä¹Ÿæ¨èï¼‰" << endl;
    
    cout << "\nè®°å¿†å£è¯€ï¼š" << endl;
    cout << "  async ç®€å•åˆå®‰å…¨ï¼Œè¿”å›å€¼å’Œå¼‚å¸¸å…¨è‡ªåŠ¨" << endl;
    cout << "  thread çµæ´»å¯æ§åˆ¶ï¼Œéœ€è¦æ—¶æ‰å»ä½¿ç”¨å®ƒ" << endl;
    cout << "  ä¸çŸ¥é€‰å“ªä¸ªæœ€å¥½ï¼Œé¦–é€‰ async å‡†æ²¡é”™" << endl;
    
    cout << "\nä»£ç ç¤ºä¾‹å¯¹æ¯”ï¼š" << endl;
    cout << "\n  // âš ï¸ thread + joinï¼ˆ5 è¡Œï¼‰" << endl;
    cout << "  int result = 0;" << endl;
    cout << "  thread t([&result]() {" << endl;
    cout << "      result = compute();" << endl;
    cout << "  });" << endl;
    cout << "  t.join();" << endl;
    
    cout << "\n  // âœ… asyncï¼ˆ1 è¡Œï¼‰" << endl;
    cout << "  int result = async(launch::async, compute).get();" << endl;
    
    cout << "\nç±»æ¯”ç†è§£ï¼š" << endl;
    cout << "  thread å°±åƒæ‰‹åŠ¨æŒ¡æ±½è½¦ï¼š" << endl;
    cout << "    - å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¡£ä½ã€è½¬é€Ÿ" << endl;
    cout << "    - çµæ´»ä½†éœ€è¦æŠ€å·§" << endl;
    cout << "    - é€‚åˆè€å¸æœºå’Œèµ›è½¦æ‰‹" << endl;
    
    cout << "\n  async å°±åƒè‡ªåŠ¨æŒ¡æ±½è½¦ï¼š" << endl;
    cout << "    - è‡ªåŠ¨æ¢æŒ¡ï¼Œçœå¿ƒçœåŠ›" << endl;
    cout << "    - ç®€å•æ˜“ç”¨" << endl;
    cout << "    - é€‚åˆå¤§å¤šæ•°äººå’Œæ—¥å¸¸é©¾é©¶" << endl;
    
    cout << "\n========================================" << endl;
}

// ============================================================================
// ä¸»å‡½æ•°
// ============================================================================

int main() {
    cout << "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" << endl;
    cout << "â•‘       async vs thread + join è¯¦ç»†å¯¹æ¯”           â•‘" << endl;
    cout << "â•‘   ç†è§£ä¸¤è€…çš„åŒºåˆ«ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·                â•‘" << endl;
    cout << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" << endl;
    
    // 1. æ ¸å¿ƒåŒºåˆ«æ¦‚è§ˆ
    explain_core_differences();
    
    // 2. è¿”å›å€¼å¤„ç†
    demonstrate_return_value();
    
    // 3. å¼‚å¸¸å¤„ç†
    demonstrate_exception_handling();
    
    // 4. èµ„æºç®¡ç†
    demonstrate_resource_management();
    
    // 5. æ‰§è¡Œç­–ç•¥
    demonstrate_launch_policy();
    
    // 6. é˜»å¡æ—¶æœº
    demonstrate_blocking_timing();
    
    // 7. æ§åˆ¶ç²’åº¦
    demonstrate_control_granularity();
    
    // 8. å®é™…åœºæ™¯å¯¹æ¯”
    demonstrate_practical_scenarios();
    
    // 9. æ€§èƒ½å¯¹æ¯”
    demonstrate_performance();
    
    // 10. ä½•æ—¶ç”¨ä»€ä¹ˆ
    when_to_use_what();
    
    // 11. æ€»ç»“
    summary();
    
    return 0;
}
