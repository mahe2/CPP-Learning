/*
 * detach() çš„å®é™…åº”ç”¨åœºæ™¯
 * æ ¸å¿ƒï¼šdetach é€‚åˆ"å‘å°„åä¸ç®¡"çš„åå°ä»»åŠ¡
 * é‡ç‚¹ï¼šç†è§£å®ƒçš„ç”¨é€”å’Œé™åˆ¶
 */

#include <iostream>
#include <thread>
#include <chrono>
#include <fstream>
#include <mutex>
#include <vector>
#include <atomic>
using namespace std;

// ============================================================================
// ä¸€ã€ä½ çš„ç–‘é—®æ˜¯å¯¹çš„ï¼detach ç¡®å®æœ‰å¾ˆå¤§é™åˆ¶
// ============================================================================

void explain_detach_problem() {
    cout << "\n=== 1. ä½ çš„ç–‘é—®æ˜¯å¯¹çš„ï¼===" << endl;
    
    cout << "\ndetach() çš„æ ¸å¿ƒé—®é¢˜ï¼š" << endl;
    cout << "  âœ… ä½ è¯´å¯¹äº†ï¼šæ— æ³•ä¿è¯æ‰§è¡Œå®Œ" << endl;
    cout << "  âœ… è¿›ç¨‹ç»“æŸ â†’ detach çº¿ç¨‹è¢«å¼ºåˆ¶ç»ˆæ­¢" << endl;
    cout << "  âœ… æ— æ³•è·å–è¿”å›å€¼" << endl;
    cout << "  âœ… éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ª" << endl;
    
    cout << "\næ‰€ä»¥ detach ä½¿ç”¨åœºæ™¯å¾ˆæœ‰é™ï¼š" << endl;
    cout << "  1. ä¸å…³å¿ƒç»“æœçš„åå°ä»»åŠ¡" << endl;
    cout << "  2. ç”Ÿå‘½å‘¨æœŸæ˜ç¡®ä¸ä¾èµ–ä¸»çº¿ç¨‹çš„ä»»åŠ¡" << endl;
    cout << "  3. å³ä½¿è¢«ä¸­æ–­ä¹Ÿæ²¡å…³ç³»çš„ä»»åŠ¡" << endl;
    
    cout << "\nå®é™…å¼€å‘ä¸­ï¼š" << endl;
    cout << "  âš ï¸ detach ä½¿ç”¨ç‡å¾ˆä½ï¼ˆ< 5%ï¼‰" << endl;
    cout << "  âœ… å¤§éƒ¨åˆ†åœºæ™¯ç”¨ joinã€asyncã€çº¿ç¨‹æ± " << endl;
    cout << "  âš ï¸ æ–°æ‰‹æœ€å¥½é¿å…ä½¿ç”¨ detach" << endl;
}

// ============================================================================
// äºŒã€detach çš„å…¸å‹åº”ç”¨åœºæ™¯
// ============================================================================

// åœºæ™¯1ï¼šæ—¥å¿—è®°å½•ï¼ˆåå°å†™å…¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
class AsyncLogger {
    mutex mtx;
    atomic<bool> should_stop{false};
    
public:
    void log(const string& message) {
        // åˆ›å»º detach çº¿ç¨‹å†™æ—¥å¿—
        thread([message, this]() {
            lock_guard<mutex> lock(mtx);
            
            // æ¨¡æ‹Ÿå†™å…¥æ–‡ä»¶
            ofstream file("app.log", ios::app);
            if (file.is_open()) {
                auto now = chrono::system_clock::now();
                auto time = chrono::system_clock::to_time_t(now);
                file << "[" << ctime(&time) << "] " << message << endl;
            }
            
            // æ³¨æ„ï¼šè¿™ä¸ªçº¿ç¨‹ä¼šç«‹å³æ‰§è¡Œå¹¶å¿«é€Ÿå®Œæˆ
        }).detach();  // âœ… å‘å°„åä¸ç®¡ï¼Œä¸»çº¿ç¨‹ä¸ç­‰å¾…
    }
    
    ~AsyncLogger() {
        should_stop = true;
        // é—®é¢˜ï¼šæ— æ³•ç¡®ä¿æ‰€æœ‰æ—¥å¿—éƒ½å†™å®Œäº†ï¼
        this_thread::sleep_for(chrono::milliseconds(100));  // ç²—æš´ç­‰å¾…
    }
};

void demonstrate_logging() {
    cout << "\n=== 2. åœºæ™¯1ï¼šå¼‚æ­¥æ—¥å¿—è®°å½• ===" << endl;
    
    cout << "\nç”¨é€”ï¼šä¸é˜»å¡ä¸»ç¨‹åºçš„æ—¥å¿—å†™å…¥" << endl;
    
    AsyncLogger logger;
    
    cout << "ä¸»çº¿ç¨‹ï¼šæ‰§è¡Œä¸šåŠ¡é€»è¾‘..." << endl;
    logger.log("åº”ç”¨å¯åŠ¨");
    logger.log("å¤„ç†è¯·æ±‚ #1");
    
    // ä¸»çº¿ç¨‹ç»§ç»­å·¥ä½œï¼Œä¸ç­‰å¾…æ—¥å¿—å†™å…¥
    cout << "ä¸»çº¿ç¨‹ï¼šç»§ç»­å·¥ä½œï¼ˆä¸ç­‰å¾…æ—¥å¿—å†™å…¥ï¼‰" << endl;
    this_thread::sleep_for(chrono::milliseconds(50));
    
    logger.log("å¤„ç†è¯·æ±‚ #2");
    
    cout << "ä¸»çº¿ç¨‹ï¼šå®Œæˆ" << endl;
    
    cout << "\nâœ… ä¼˜ç‚¹ï¼šæ—¥å¿—å†™å…¥ä¸é˜»å¡ä¸»çº¿ç¨‹" << endl;
    cout << "âš ï¸ ç¼ºç‚¹ï¼šç¨‹åºé€€å‡ºæ—¶å¯èƒ½æœ‰æ—¥å¿—æœªå†™å®Œ" << endl;
    cout << "ğŸ’¡ å®é™…ï¼šç”Ÿäº§ç¯å¢ƒé€šå¸¸ç”¨æ—¥å¿—åº“ï¼ˆå¦‚ spdlogï¼‰" << endl;
}

// åœºæ™¯2ï¼šå¿ƒè·³æ£€æµ‹ï¼ˆåå°å®šæœŸå‘é€å¿ƒè·³ï¼‰
class HeartbeatMonitor {
    atomic<bool> running{true};
    
public:
    void start() {
        thread([this]() {
            cout << "  [å¿ƒè·³çº¿ç¨‹] å¯åŠ¨" << endl;
            
            while (running) {
                // å‘é€å¿ƒè·³
                cout << "  [å¿ƒè·³] â™¥" << endl;
                this_thread::sleep_for(chrono::seconds(1));
            }
            
            cout << "  [å¿ƒè·³çº¿ç¨‹] åœæ­¢" << endl;
        }).detach();  // âœ… åå°è¿è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
    }
    
    void stop() {
        running = false;
        // é—®é¢˜ï¼šæ— æ³•ç¡®ä¿çº¿ç¨‹å·²ç»åœæ­¢ï¼
        this_thread::sleep_for(chrono::milliseconds(1100));  // ç²—æš´ç­‰å¾…
    }
};

void demonstrate_heartbeat() {
    cout << "\n=== 3. åœºæ™¯2ï¼šå¿ƒè·³æ£€æµ‹ ===" << endl;
    
    cout << "\nç”¨é€”ï¼šåå°å®šæœŸå‘é€å¿ƒè·³åŒ…" << endl;
    
    HeartbeatMonitor monitor;
    monitor.start();
    
    cout << "[ä¸»çº¿ç¨‹] æ‰§è¡Œä¸šåŠ¡é€»è¾‘..." << endl;
    this_thread::sleep_for(chrono::milliseconds(3500));
    
    cout << "[ä¸»çº¿ç¨‹] å‡†å¤‡åœæ­¢" << endl;
    monitor.stop();
    
    cout << "\nâœ… ä¼˜ç‚¹ï¼šå¿ƒè·³åœ¨åå°è‡ªåŠ¨è¿è¡Œ" << endl;
    cout << "âš ï¸ ç¼ºç‚¹ï¼šåœæ­¢æœºåˆ¶å¤æ‚ï¼Œéœ€è¦é¢å¤–çš„é€šä¿¡æœºåˆ¶" << endl;
}

// åœºæ™¯3ï¼šå¯åŠ¨åå°æœåŠ¡ï¼ˆGUI ç¨‹åºçš„äº‹ä»¶å¾ªç¯ï¼‰
void demonstrate_background_service() {
    cout << "\n=== 4. åœºæ™¯3ï¼šåå°æœåŠ¡ ===" << endl;
    
    cout << "\nç”¨é€”ï¼šGUI ç¨‹åºä¸­çš„åå°æœåŠ¡çº¿ç¨‹" << endl;
    
    // æ¨¡æ‹Ÿå¯åŠ¨ä¸€ä¸ªåå°æœåŠ¡
    thread([]() {
        cout << "  [åå°æœåŠ¡] å¯åŠ¨" << endl;
        
        // æ¨¡æ‹Ÿé•¿æœŸè¿è¡Œçš„æœåŠ¡
        for (int i = 0; i < 5; i++) {
            cout << "  [åå°æœåŠ¡] å¤„ç†äº‹ä»¶ " << i + 1 << endl;
            this_thread::sleep_for(chrono::milliseconds(500));
        }
        
        cout << "  [åå°æœåŠ¡] ç»“æŸ" << endl;
    }).detach();
    
    cout << "[ä¸»çº¿ç¨‹] GUI ç»§ç»­å“åº”ç”¨æˆ·æ“ä½œ..." << endl;
    this_thread::sleep_for(chrono::milliseconds(3000));
    
    cout << "\nâœ… ä¼˜ç‚¹ï¼šä¸»çº¿ç¨‹ä¸é˜»å¡ï¼ŒGUI ä¿æŒå“åº”" << endl;
    cout << "âš ï¸ ç¼ºç‚¹ï¼šä¸»çª—å£å…³é—­æ—¶ï¼ŒæœåŠ¡çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢" << endl;
}

// ============================================================================
// ä¸‰ã€detach çš„æ ¹æœ¬é—®é¢˜ï¼šæ— æ³•ä¿è¯æ‰§è¡Œå®Œ
// ============================================================================

void demonstrate_detach_problem() {
    cout << "\n=== 5. detach çš„æ ¹æœ¬é—®é¢˜ ===" << endl;
    
    cout << "\né—®é¢˜æ¼”ç¤ºï¼šä¸»çº¿ç¨‹æå‰é€€å‡º" << endl;
    
    cout << "å¯åŠ¨ detach çº¿ç¨‹ï¼ˆéœ€è¦ 3 ç§’ï¼‰..." << endl;
    
    thread([]() {
        cout << "  [detach çº¿ç¨‹] å¼€å§‹å·¥ä½œ" << endl;
        
        for (int i = 1; i <= 3; i++) {
            this_thread::sleep_for(chrono::seconds(1));
            cout << "  [detach çº¿ç¨‹] å·¥ä½œè¿›åº¦: " << i << "/3" << endl;
        }
        
        cout << "  [detach çº¿ç¨‹] å·¥ä½œå®Œæˆï¼" << endl;
    }).detach();
    
    // ä¸»çº¿ç¨‹åªç­‰ 1 ç§’å°±é€€å‡º
    cout << "[ä¸»çº¿ç¨‹] ç­‰å¾… 1 ç§’åé€€å‡º..." << endl;
    this_thread::sleep_for(chrono::seconds(1));
    cout << "[ä¸»çº¿ç¨‹] å‡†å¤‡é€€å‡ºï¼ˆdetach çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢ï¼‰" << endl;
    
    // æ³¨æ„ï¼šè¿™é‡Œæ¼”ç¤ºç”¨ï¼Œå®é™…ä¼šåœ¨ main ç»“æŸæ—¶ç»ˆæ­¢
    this_thread::sleep_for(chrono::milliseconds(100));
    
    cout << "\nè§‚å¯Ÿï¼šdetach çº¿ç¨‹çš„ 2/3 å’Œ 3/3 å¯èƒ½ä¸ä¼šè¾“å‡ºï¼" << endl;
    cout << "åŸå› ï¼šä¸»çº¿ç¨‹é€€å‡º â†’ è¿›ç¨‹ç»“æŸ â†’ detach çº¿ç¨‹è¢«æ€" << endl;
}

// ============================================================================
// å››ã€detach çš„æ­£ç¡®ç”¨æ³•ï¼šç¡®ä¿ä¸»çº¿ç¨‹ä¸æå‰é€€å‡º
// ============================================================================

void demonstrate_correct_detach_usage() {
    cout << "\n=== 6. detach çš„æ­£ç¡®ç”¨æ³• ===" << endl;
    
    cout << "\næ–¹æ³•1ï¼šç¡®ä¿ä¸»çº¿ç¨‹è¶³å¤Ÿé•¿å¯¿" << endl;
    
    thread([]() {
        for (int i = 0; i < 3; i++) {
            cout << "  [detach] å·¥ä½œ " << i + 1 << endl;
            this_thread::sleep_for(chrono::milliseconds(500));
        }
    }).detach();
    
    // ä¸»çº¿ç¨‹è¦æ´»å¾—å¤Ÿä¹…
    cout << "[ä¸»çº¿ç¨‹] æŒç»­è¿è¡Œä¸­..." << endl;
    this_thread::sleep_for(chrono::seconds(2));  // âœ… ç¡®ä¿ detach çº¿ç¨‹æœ‰æ—¶é—´å®Œæˆ
    
    cout << "\næ–¹æ³•2ï¼šä½¿ç”¨åŒæ­¥æœºåˆ¶é€šçŸ¥å®Œæˆ" << endl;
    
    atomic<bool> task_done{false};
    
    thread([&task_done]() {
        cout << "  [detach] å¼€å§‹ä»»åŠ¡" << endl;
        this_thread::sleep_for(chrono::milliseconds(500));
        cout << "  [detach] ä»»åŠ¡å®Œæˆ" << endl;
        task_done = true;  // âœ… é€šçŸ¥ä¸»çº¿ç¨‹
    }).detach();
    
    // ä¸»çº¿ç¨‹ç­‰å¾…å®Œæˆæ ‡å¿—
    cout << "[ä¸»çº¿ç¨‹] ç­‰å¾…ä»»åŠ¡å®Œæˆ..." << endl;
    while (!task_done) {
        this_thread::sleep_for(chrono::milliseconds(100));
    }
    cout << "[ä¸»çº¿ç¨‹] ç¡®è®¤ä»»åŠ¡å®Œæˆ" << endl;
    
    cout << "\nğŸ’¡ ä½†æ˜¯ï¼šå¦‚æœè¦ç­‰å¾…å®Œæˆï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ joinï¼Ÿ" << endl;
}

// ============================================================================
// äº”ã€detach vs join vs asyncï¼šä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆï¼Ÿ
// ============================================================================

void compare_thread_management() {
    cout << "\n=== 7. detach vs join vs async ===" << endl;
    
    cout << "\nå¯¹æ¯”è¡¨æ ¼ï¼š" << endl;
    cout << "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" << endl;
    cout << "  â”‚ ç‰¹æ€§         â”‚ join       â”‚ detach     â”‚ async        â”‚" << endl;
    cout << "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" << endl;
    cout << "  â”‚ é˜»å¡ä¸»çº¿ç¨‹   â”‚ âœ… æ˜¯      â”‚ âŒ å¦      â”‚ âš ï¸ get æ—¶    â”‚" << endl;
    cout << "  â”‚ è·å–è¿”å›å€¼   â”‚ âš ï¸ é—´æ¥    â”‚ âŒ ä¸èƒ½    â”‚ âœ… ç›´æ¥      â”‚" << endl;
    cout << "  â”‚ ä¿è¯æ‰§è¡Œå®Œ   â”‚ âœ… æ˜¯      â”‚ âŒ å¦      â”‚ âœ… æ˜¯        â”‚" << endl;
    cout << "  â”‚ æ§åˆ¶çº¿ç¨‹     â”‚ âœ… å¯æ§    â”‚ âŒ å¤±æ§    â”‚ âœ… å¯æ§      â”‚" << endl;
    cout << "  â”‚ èµ„æºç®¡ç†     â”‚ âœ… æ‰‹åŠ¨    â”‚ âš ï¸ è‡ªåŠ¨ä½†å±é™©â”‚ âœ… è‡ªåŠ¨å®‰å…¨  â”‚" << endl;
    cout << "  â”‚ ä½¿ç”¨éš¾åº¦     â”‚ â­â­      â”‚ â­â­â­â­  â”‚ â­          â”‚" << endl;
    cout << "  â”‚ æ¨èåº¦       â”‚ âœ… é«˜      â”‚ âš ï¸ ä½      â”‚ âœ… æœ€é«˜      â”‚" << endl;
    cout << "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" << endl;
    
    cout << "\nä½¿ç”¨å»ºè®®ï¼š" << endl;
    cout << "  1ï¸âƒ£ é»˜è®¤é€‰æ‹©ï¼šstd::async" << endl;
    cout << "  2ï¸âƒ£ éœ€è¦ç²¾ç¡®æ§åˆ¶ï¼šthread + join" << endl;
    cout << "  3ï¸âƒ£ ç‰¹æ®Šåå°ä»»åŠ¡ï¼šthread + detachï¼ˆè°¨æ…ä½¿ç”¨ï¼‰" << endl;
}

// ============================================================================
// å…­ã€detach çš„å®é™…åº”ç”¨åœºæ™¯æ€»ç»“
// ============================================================================

void practical_detach_scenarios() {
    cout << "\n=== 8. detach çš„å®é™…åº”ç”¨åœºæ™¯ ===" << endl;
    
    cout << "\nâœ… é€‚åˆä½¿ç”¨ detach çš„åœºæ™¯ï¼š" << endl;
    cout << "  1. å¼‚æ­¥æ—¥å¿—è®°å½•" << endl;
    cout << "     - å¿«é€Ÿå®Œæˆï¼Œå³ä½¿ä¸¢å¤±ä¸€ä¸¤æ¡ä¹Ÿæ— å…³ç´§è¦" << endl;
    cout << "     - ä¾‹ï¼šlogger.log(\"info\");" << endl;
    
    cout << "\n  2. ç»Ÿè®¡ä¸ŠæŠ¥" << endl;
    cout << "     - å®šæœŸä¸ŠæŠ¥ç»Ÿè®¡æ•°æ®åˆ°æœåŠ¡å™¨" << endl;
    cout << "     - å¤±è´¥äº†ä¸‹æ¬¡å†æŠ¥ï¼Œä¸å½±å“ä¸»é€»è¾‘" << endl;
    
    cout << "\n  3. èµ„æºæ¸…ç†" << endl;
    cout << "     - åˆ é™¤ä¸´æ—¶æ–‡ä»¶ã€æ¸…ç†ç¼“å­˜" << endl;
    cout << "     - å³ä½¿æ²¡æ¸…ç†å®Œï¼Œä¸‹æ¬¡å¯åŠ¨å†æ¸…ç†" << endl;
    
    cout << "\n  4. GUI ç¨‹åºçš„ç‹¬ç«‹çª—å£" << endl;
    cout << "     - æ‰“å¼€ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è¯æ¡†çª—å£" << endl;
    cout << "     - çª—å£æœ‰è‡ªå·±çš„äº‹ä»¶å¾ªç¯ï¼Œç”Ÿå‘½å‘¨æœŸç‹¬ç«‹" << endl;
    
    cout << "\nâŒ ä¸é€‚åˆä½¿ç”¨ detach çš„åœºæ™¯ï¼š" << endl;
    cout << "  1. éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼ˆç”¨ asyncï¼‰" << endl;
    cout << "  2. éœ€è¦ç¡®ä¿å®Œæˆçš„ä»»åŠ¡ï¼ˆç”¨ joinï¼‰" << endl;
    cout << "  3. è®¿é—®æ ˆä¸Šå˜é‡çš„ä»»åŠ¡ï¼ˆå±é™©ï¼ï¼‰" << endl;
    cout << "  4. éœ€è¦å–æ¶ˆæˆ–æ§åˆ¶çš„ä»»åŠ¡ï¼ˆç”¨ std::jthreadï¼‰" << endl;
    cout << "  5. å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆç”¨çº¿ç¨‹æ± ï¼‰" << endl;
}

// ============================================================================
// ä¸ƒã€å®é™…å¼€å‘ä¸­çš„æ›¿ä»£æ–¹æ¡ˆ
// ============================================================================

void better_alternatives() {
    cout << "\n=== 9. æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ ===" << endl;
    
    cout << "\né—®é¢˜ï¼šæˆ‘æƒ³è¦åå°ä»»åŠ¡ï¼Œä½†ä¸æƒ³é˜»å¡ä¸»çº¿ç¨‹" << endl;
    
    cout << "\næ–¹æ¡ˆ1ï¼šstd::async + launch::asyncï¼ˆæ¨èï¼‰" << endl;
    cout << "  auto future = async(launch::async, []() {" << endl;
    cout << "      // åå°ä»»åŠ¡" << endl;
    cout << "      return 42;" << endl;
    cout << "  });" << endl;
    cout << "  // ä¸»çº¿ç¨‹ç»§ç»­å·¥ä½œ..." << endl;
    cout << "  // éœ€è¦ç»“æœæ—¶ï¼šauto result = future.get();" << endl;
    cout << "  âœ… ä¼˜ç‚¹ï¼šå¯ä»¥è·å–è¿”å›å€¼ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ" << endl;
    
    cout << "\næ–¹æ¡ˆ2ï¼šçº¿ç¨‹æ± ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰" << endl;
    cout << "  ThreadPool pool(4);" << endl;
    cout << "  auto future = pool.submit(task);" << endl;
    cout << "  âœ… ä¼˜ç‚¹ï¼šå¤ç”¨çº¿ç¨‹ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯ï¼Œç»Ÿä¸€ç®¡ç†" << endl;
    
    cout << "\næ–¹æ¡ˆ3ï¼šC++20 std::jthreadï¼ˆæœªæ¥æ¨èï¼‰" << endl;
    cout << "  jthread t([]() { /* ä»»åŠ¡ */ });" << endl;
    cout << "  // ææ„æ—¶è‡ªåŠ¨ joinï¼Œæ”¯æŒå–æ¶ˆ" << endl;
    cout << "  âœ… ä¼˜ç‚¹ï¼šRAIIï¼Œè‡ªåŠ¨ç®¡ç†ï¼Œæ”¯æŒåœæ­¢ä»¤ç‰Œ" << endl;
    
    cout << "\næ–¹æ¡ˆ4ï¼šæ¶ˆæ¯é˜Ÿåˆ— + å·¥ä½œçº¿ç¨‹" << endl;
    cout << "  queue<Task> tasks;" << endl;
    cout << "  thread worker([&tasks]() {" << endl;
    cout << "      while (true) {" << endl;
    cout << "          Task task = tasks.pop();" << endl;
    cout << "          task.execute();" << endl;
    cout << "      }" << endl;
    cout << "  });" << endl;
    cout << "  âœ… ä¼˜ç‚¹ï¼šè§£è€¦ï¼Œå¯æ§ï¼Œé€‚åˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼" << endl;
}

// ============================================================================
// å…«ã€æ ¸å¿ƒæ€»ç»“
// ============================================================================

void summary() {
    cout << "\n========================================" << endl;
    cout << "           æ ¸å¿ƒæ€»ç»“" << endl;
    cout << "========================================" << endl;
    
    cout << "\nä½ çš„ç–‘é—®æ˜¯å¯¹çš„ï¼" << endl;
    cout << "  âœ… detach ç¡®å®æ— æ³•ä¿è¯æ‰§è¡Œå®Œ" << endl;
    cout << "  âœ… è¿›ç¨‹ç»“æŸ â†’ detach çº¿ç¨‹è¢«æ€" << endl;
    cout << "  âœ… è¿™æ˜¯ detach çš„æ ¹æœ¬é™åˆ¶" << endl;
    
    cout << "\ndetach çš„ç”¨é€”ï¼ˆå¾ˆæœ‰é™ï¼‰ï¼š" << endl;
    cout << "  1. \"å‘å°„åä¸ç®¡\"çš„åå°ä»»åŠ¡" << endl;
    cout << "  2. å³ä½¿è¢«ä¸­æ–­ä¹Ÿæ— å…³ç´§è¦çš„ä»»åŠ¡" << endl;
    cout << "  3. å¿«é€Ÿå®Œæˆçš„ç‹¬ç«‹ä»»åŠ¡" << endl;
    
    cout << "\nå…¸å‹åœºæ™¯ï¼š" << endl;
    cout << "  âœ… å¼‚æ­¥æ—¥å¿—ï¼ˆä¸¢ä¸€ä¸¤æ¡æ— æ‰€è°“ï¼‰" << endl;
    cout << "  âœ… ç»Ÿè®¡ä¸ŠæŠ¥ï¼ˆå¤±è´¥äº†ä¸‹æ¬¡å†æŠ¥ï¼‰" << endl;
    cout << "  âœ… èµ„æºæ¸…ç†ï¼ˆä¸‹æ¬¡å¯åŠ¨å†æ¸…ç†ï¼‰" << endl;
    cout << "  âŒ å…³é”®ä¸šåŠ¡é€»è¾‘ï¼ˆä¸è¦ç”¨ detachï¼ï¼‰" << endl;
    
    cout << "\ndetach çš„æ ¹æœ¬é—®é¢˜ï¼š" << endl;
    cout << "  1. æ— æ³•è·å–è¿”å›å€¼" << endl;
    cout << "  2. æ— æ³•ä¿è¯æ‰§è¡Œå®Œæˆ" << endl;
    cout << "  3. éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ª" << endl;
    cout << "  4. å®¹æ˜“è®¿é—®å·²é”€æ¯çš„å˜é‡ï¼ˆå¼•ç”¨æ•è·ï¼‰" << endl;
    cout << "  5. ä¸»çº¿ç¨‹é€€å‡º â†’ å¼ºåˆ¶ç»ˆæ­¢" << endl;
    
    cout << "\nä½¿ç”¨å»ºè®®ï¼ˆé‡è¦ï¼ï¼‰ï¼š" << endl;
    cout << "  ğŸ¥‡ é¦–é€‰ï¼šstd::asyncï¼ˆæœ€å®‰å…¨ã€æœ€çµæ´»ï¼‰" << endl;
    cout << "  ğŸ¥ˆ æ¬¡é€‰ï¼šthread + joinï¼ˆå¯æ§ã€å¯é ï¼‰" << endl;
    cout << "  ğŸ¥‰ æ…ç”¨ï¼šthread + detachï¼ˆä»…ç‰¹æ®Šåœºæ™¯ï¼‰" << endl;
    cout << "  ğŸ† ç”Ÿäº§ç¯å¢ƒï¼šçº¿ç¨‹æ± ï¼ˆé«˜æ•ˆã€ç»Ÿä¸€ç®¡ç†ï¼‰" << endl;
    
    cout << "\nå®é™…ç»Ÿè®¡ï¼š" << endl;
    cout << "  åœ¨ç”Ÿäº§ä»£ç ä¸­ï¼š" << endl;
    cout << "  - async: ~60%" << endl;
    cout << "  - thread + join: ~30%" << endl;
    cout << "  - thread + detach: ~5%" << endl;
    cout << "  - å…¶ä»–ï¼ˆçº¿ç¨‹æ± ç­‰ï¼‰: ~5%" << endl;
    
    cout << "\ndetach ä½¿ç”¨åŸåˆ™ï¼š" << endl;
    cout << "  âš ï¸ å¦‚æœä½ ä¸ç¡®å®šæ˜¯å¦è¯¥ç”¨ detach â†’ ä¸è¦ç”¨ï¼" << endl;
    cout << "  âš ï¸ å¦‚æœä»»åŠ¡éœ€è¦ä¿è¯å®Œæˆ â†’ ä¸è¦ç”¨ detachï¼" << endl;
    cout << "  âš ï¸ å¦‚æœéœ€è¦è¿”å›å€¼ â†’ ä¸è¦ç”¨ detachï¼" << endl;
    cout << "  âš ï¸ å¦‚æœéœ€è¦è°ƒè¯• â†’ ä¸è¦ç”¨ detachï¼" << endl;
    
    cout << "\nè®°å¿†å£è¯€ï¼š" << endl;
    cout << "  detach å‘å°„ä¸ç®¡ï¼Œç»“æœæ— æ³•ä¿éšœ" << endl;
    cout << "  è¿›ç¨‹ä¸€é€€å°±å®Œï¼Œä»»åŠ¡è¢«è¿«ä¸­æ–­" << endl;
    cout << "  æ—¥å¿—ç»Ÿè®¡å¯ç”¨ï¼Œå…³é”®ä¸šåŠ¡ä¸è¡Œ" << endl;
    cout << "  é¦–é€‰ async æ–¹æ¡ˆï¼Œæ¬¡é€‰ join ä¿é™©" << endl;
    
    cout << "\nç±»æ¯”ç†è§£ï¼š" << endl;
    cout << "  detach å°±åƒå‘å°„ç«ç®­ï¼š" << endl;
    cout << "  - å‘å°„åå¤±å»æ§åˆ¶" << endl;
    cout << "  - ä¸çŸ¥é“æœ€ç»ˆæ˜¯å¦æˆåŠŸ" << endl;
    cout << "  - åœ°é¢ç«™å…³é—­ â†’ ç«ç®­è‡ªç”Ÿè‡ªç­" << endl;
    cout << "  - åªé€‚åˆï¼šæ¢æµ‹ä»»åŠ¡ï¼ˆæˆåŠŸæœ€å¥½ï¼Œå¤±è´¥ä¹Ÿèƒ½æ¥å—ï¼‰" << endl;
    cout << "  - ä¸é€‚åˆï¼šè½½äººä»»åŠ¡ï¼ˆå¿…é¡»ä¿è¯å®‰å…¨è¿”å›ï¼‰" << endl;
    
    cout << "\n========================================" << endl;
}

// ============================================================================
// ä¸»å‡½æ•°
// ============================================================================

int main() {
    cout << "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" << endl;
    cout << "â•‘         detach() çš„å®é™…åº”ç”¨åœºæ™¯               â•‘" << endl;
    cout << "â•‘   ä¸ºä»€ä¹ˆæ— æ³•ä¿è¯æ‰§è¡Œå®Œï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ           â•‘" << endl;
    cout << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" << endl;
    
    // 1. è§£é‡Šä½ çš„ç–‘é—®æ˜¯å¯¹çš„
    explain_detach_problem();
    
    // 2. åœºæ™¯1ï¼šå¼‚æ­¥æ—¥å¿—
    demonstrate_logging();
    
    // 3. åœºæ™¯2ï¼šå¿ƒè·³æ£€æµ‹
    demonstrate_heartbeat();
    
    // 4. åœºæ™¯3ï¼šåå°æœåŠ¡
    demonstrate_background_service();
    
    // 5. detach çš„æ ¹æœ¬é—®é¢˜
    demonstrate_detach_problem();
    
    // 6. detach çš„æ­£ç¡®ç”¨æ³•
    demonstrate_correct_detach_usage();
    
    // 7. å¯¹æ¯”ä¸åŒæ–¹æ¡ˆ
    compare_thread_management();
    
    // 8. å®é™…åº”ç”¨åœºæ™¯
    practical_detach_scenarios();
    
    // 9. æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ
    better_alternatives();
    
    // 10. æ€»ç»“
    summary();
    
    // ç¡®ä¿æ‰€æœ‰ detach çº¿ç¨‹æœ‰æ—¶é—´å®Œæˆ
    cout << "\n[ä¸»çº¿ç¨‹] ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡..." << endl;
    this_thread::sleep_for(chrono::seconds(1));
    cout << "[ä¸»çº¿ç¨‹] ç¨‹åºç»“æŸ" << endl;
    
    return 0;
}
